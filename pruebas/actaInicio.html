<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acta de Inicio de Contrato</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .form-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h2 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 24px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        label {
            display: block;
            font-weight: bold;
            color: #333;
            margin-bottom: 6px;
            font-size: 14px;
        }
        
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        
        .btn {
            flex: 1;
            border: none;
            padding: 14px;
            border-radius: 6px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .btn-pdf {
            background: #e74c3c;
            color: white;
        }
        
        .btn-pdf:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .btn-preview {
            background: #3498db;
            color: white;
        }
        
        .btn-preview:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="form-section">
            <h2>üìù Acta de Inicio de Contrato</h2>
            
            <div class="form-group">
                <label>N√∫mero de Contrato:</label>
                <input type="text" id="numeroContrato" value="011025-594">
            </div>
            
            <div class="form-group">
                <label>Fecha de Contrato:</label>
                <input type="date" id="fechaContrato" value="2025-10-01">
            </div>
            
            <div class="form-group">
                <label>Fecha de Inicio:</label>
                <input type="date" id="fechaInicio" value="2025-10-01">
            </div>
            

            
            <div class="form-group">
                <label>Valor Total:</label>
                <input type="text" id="valorTotal" value="$ 1.550.000">
            </div>
            
            <div class="form-group">
                <label>N√∫mero de Meses:</label>
                <input type="number" id="numeroMeses" value="1" min="1">
            </div>
            
            <div class="form-group">
                <label>Nombre del Contratista:</label>
                <input type="text" id="nombreContratista" value="ALBEIRO CAMARGO ARENILLA">
            </div>
            
            <div class="form-group">
                <label>C√©dula del Contratista:</label>
                <input type="text" id="cedulaContratista" placeholder="Ej: 12.345.678">
            </div>
            
            <div class="form-group">
                <label>Garant√≠as:</label>
                <textarea id="garantias" placeholder="Escriba las garant√≠as requeridas"></textarea>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-pdf" onclick="generarPDFActaInicio()">üìÑ Generar PDF</button>
            </div>
        </div>
    </div>
    
    <script>
        // Funci√≥n para cargar la marca de agua
        async function loadWatermark() {
            try {
                const response = await fetch('../../componentes/marcadeaguaJURIDICA.png');
                const blob = await response.blob();
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.log("‚ö†Ô∏è Error cargando la marca de agua:", error);
                return null;
            }
        }
        
        // Funci√≥n para convertir n√∫mero a texto en espa√±ol
        function numeroATexto(num) {
            const unidades = ['', 'uno', 'dos', 'tres', 'cuatro', 'cinco', 'seis', 'siete', 'ocho', 'nueve'];
            const decenas = ['', '', 'veinte', 'treinta', 'cuarenta', 'cincuenta', 'sesenta', 'setenta', 'ochenta', 'noventa'];
            const especiales = ['diez', 'once', 'doce', 'trece', 'catorce', 'quince', 'diecis√©is', 'diecisiete', 'dieciocho', 'diecinueve'];
            
            if (num < 10) return unidades[num];
            if (num >= 10 && num < 20) return especiales[num - 10];
            if (num >= 20 && num < 100) {
                const dec = Math.floor(num / 10);
                const uni = num % 10;
                return decenas[dec] + (uni > 0 ? ' y ' + unidades[uni] : '');
            }
            return num.toString();
        }
        
        // Funci√≥n para formatear fecha a texto
        function formatearFechaTexto(fechaStr) {
            const meses = ['ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO', 
                          'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];
            const fecha = new Date(fechaStr + 'T00:00:00');
            const dia = fecha.getDate();
            const mes = meses[fecha.getMonth()];
            const anio = fecha.getFullYear();
            return `${dia} DE ${mes} DE ${anio}`;
        }
        
        // Funci√≥n para formatear fecha corta
        function formatearFechaCorta(fechaStr) {
            const fecha = new Date(fechaStr + 'T00:00:00');
            const dia = fecha.getDate();
            const mes = fecha.getMonth() + 1;
            const anio = fecha.getFullYear();
            return `${dia}/${mes}/${anio}`;
        }
        
        // Funci√≥n para calcular valor mensual
        function calcularValorMensual(valorTotal, numeroMeses) {
            const valor = parseFloat(valorTotal.replace(/[$.]/g, '').replace(',', '.'));
            const mensual = valor / numeroMeses;
            return '$ ' + mensual.toLocaleString('es-CO', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        }
        
        // Funci√≥n para generar el contenido del PDF
        function generarContenidoPDFdeActaInicio() {
                const numeroContrato = document.getElementById('numeroContrato').value;
                const fechaContrato = document.getElementById('fechaContrato').value;
                const fechaInicio = document.getElementById('fechaInicio').value;
                
                const valorTotal = document.getElementById('valorTotal').value;
                const numeroMeses = parseInt(document.getElementById('numeroMeses').value) || 1;
                const nombreContratista = document.getElementById('nombreContratista').value;
                const cedulaContratista = document.getElementById('cedulaContratista').value;
                const garantias = document.getElementById('garantias').value;

                const fechaContratoTexto = formatearFechaTexto(fechaContrato);
                const fechaContratoCorta = formatearFechaCorta(fechaContrato);
                const fechaInicioCorta = formatearFechaCorta(fechaInicio);
                const valorMensual = calcularValorMensual(valorTotal, numeroMeses);
                const textoMeses = numeroMeses === 1 ? 'una cuota mensual' : `${numeroMeses} cuotas mensuales`;
                const numeroMesesTexto = numeroATexto(numeroMeses);
                const palabraMes = numeroMeses === 1 ? 'mes' : 'meses';

                const objeto = `PRESTACION DE SERVICIOS DE APOYO A LA GESTION COMO CELADOR EN LAS DIFERENTES DEPENDENCIAS DE LA ALCALDIA MUNICIPAL DE EL BANCO, MAGDALENA`;

                const formaPago = `El valor total del contrato ser√° cancelado en ${textoMeses} vencidas, por valor de ${valorMensual}, previo informe de actividades, pago a su seguridad social y recibido de conformidad por parte del Supervisor del Contrato.`;

                const contenido = {
                    titulo: `ACTA DE INICIO DEL CONTRATO DE PRESTACI√ìN DE SERVICIOS DE APOYO A LA GESTION\nNo ${numeroContrato} DE FECHA ${fechaContratoTexto}`,

                    tabla: [
                        { campo: 'FECHA ELABORACION', valor: fechaContratoCorta },
                        { campo: 'CIUDAD', valor: 'El Banco ‚Äì Magdalena' },
                        { campo: 'CONTRATO No', valor: `${numeroContrato} DE FECHA ${fechaContratoTexto}` },
                        { campo: 'OBJETO', valor: objeto },
                        { campo: 'VALOR', valor: valorTotal },
                        { campo: 'ANTICIPO:', valor: '$ 0' },
                        { campo: 'FORMA DE PAGO:', valor: formaPago },
                        { campo: 'NOMBRE DEL CONTRATISTA', valor: nombreContratista },
                        { campo: 'NOMBRE SUPERVISOR', valor: 'ISOLINA ALICIA VIDES MARTINEZ' },
                        { campo: 'CARGO:', valor: 'SECRETARIA ADMINISTRATIVA Y FINANCIERA' },
                        { campo: 'PLAZO INICIAL', valor: `Un (${numeroMeses}) ${palabraMes}` },
                        { campo: 'Garant√≠as', valor: garantias || 'No se solicitaron' },
                        { campo: 'FECHA DE INICIO', valor: fechaInicioCorta }
                    ],

                    // Este texto tiene saltos de l√≠nea, pero ser√° limpiado en la otra funci√≥n.
                    textoActa: `Los suscritos ISOLINA ALICIA VIDES MARTINEZ, identificada con la c√©dula de ciudadan√≠a No 39.023.360 
                            expedida en El Banco, Magdalena, en calidad de Secretaria Administrativa y Financiera Municipal, designada por el 
                            se√±or alcalde municipal como supervisora del presente contrato, ${nombreContratista}, identificado con cedula de 
                            ciudadan√≠a No ${cedulaContratista || '__________'} expedida en El Banco, Magdalena, dejan constancia del inicio 
                            del contrato anteriormente citado, previo cumplimiento de los requisitos de perfeccionamiento y presentaci√≥n de todos 
                            los soportes documentales exigidos.\n\nPara constancia de lo anterior, se firma la presente acta bajo la responsabilidad 
                            expresa de los que intervienen en ella.`,

                    firmas: [
                        {
                            nombre: 'ISOLINA ALICIA VIDES MARTINEZ',
                            cargo: 'Supervisor del contrato'
                        },
                        {
                            nombre: nombreContratista,
                            cargo: 'Contratista'
                        }
                    ]
                };

                return contenido;
            }
        
        // Funci√≥n para generar PDF con jsPDF
        async function generarPDFActaInicio() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: [215.9, 355.9]
            });

            const topLetter = 1.2;
            const margins = {
                top: 45 + (topLetter * 10),
                bottom: 65,
                left: 30,
                right: 25
            };

            const pageWidth = 215.9;
            const pageHeight = 355.9;
            const textWidth = pageWidth - margins.left - margins.right;

            // Cargar marca de agua
            const watermarkData = await loadWatermark();
            if (watermarkData) {
                pdf.addImage(watermarkData, 'PNG', 0, 0, pageWidth, pageHeight, undefined, 'NONE');
                pdf.setGState(new pdf.GState({ opacity: 0.1 }));
                pdf.setGState(new pdf.GState({ opacity: 1.0 }));
            }

            const contenido = generarContenidoPDFdeActaInicio();
            let yPos = margins.top;

            // T√≠tulo
            pdf.setFontSize(11);
            pdf.setFont(undefined, 'bold');
            const tituloLines = pdf.splitTextToSize(contenido.titulo, textWidth);
            tituloLines.forEach(line => {
                pdf.text(line, pageWidth / 2, yPos, { align: 'center' });
                yPos += 6;
            });

            yPos += 5;

            // ---
            // ## Tabla (Ajustes de Dise√±o para un aspecto m√°s compacto)
            // ---
            const cellMinHeight = 6; 
            const lineSpacingInsideCell = 3.5; 
            const verticalPadding = 4;
            const col1Width = textWidth * 0.35;
            const col2Width = textWidth * 0.65;

            pdf.setFontSize(8); 

            contenido.tabla.forEach(row => {
                const textLines = pdf.splitTextToSize(row.valor, col2Width - 4);
                const neededHeight = Math.max(cellMinHeight, textLines.length * lineSpacingInsideCell + 1);

                if (yPos + neededHeight > pageHeight - margins.bottom) {
                    pdf.addPage();
                    yPos = margins.top;
                }

                // Celda 1 (Campo/Etiqueta)
                pdf.setFillColor(245, 245, 245);
                pdf.rect(margins.left, yPos, col1Width, neededHeight, 'F');
                pdf.rect(margins.left, yPos, col1Width, neededHeight);
                pdf.setFont(undefined, 'bold');
                pdf.text(row.campo, margins.left + 2, yPos + verticalPadding); 

                // Celda 2 (Valor)
                pdf.rect(margins.left + col1Width, yPos, col2Width, neededHeight);
                pdf.setFont(undefined, 'normal');
                textLines.forEach((line, index) => {
                    pdf.text(line, margins.left + col1Width + 2, yPos + verticalPadding + (index * lineSpacingInsideCell)); 
                });

                yPos += neededHeight;
            });

            yPos += 10;

            // ---
            // ## TEXTO DEL ACTA CON JUSTIFICACI√ìN (UNIFORME)
            // ---
            if (yPos > pageHeight - margins.bottom - 50) {
                pdf.addPage();
                yPos = margins.top;
            }

            // Establecer el estilo de fuente para el cuerpo del texto
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            const lineHeight = 5;

            // 1. Unificar y limpiar el texto. ESTE PASO ES CLAVE para la justificaci√≥n.
            const textoLimpio = contenido.textoActa
                .replace(/\n/g, ' ') 
                .replace(/\r/g, ' ')
                .replace(/\t/g, ' ')
                .replace(/\s+/g, ' ') // Reducir m√∫ltiples espacios a uno solo
                .trim();

            // 2. Dividir el texto en un array de l√≠neas que caben en el ancho del documento (textWidth)
            const lineasActa = pdf.splitTextToSize(textoLimpio, textWidth);

            // 3. Recorrer el array e imprimir cada l√≠nea con justificaci√≥n
            lineasActa.forEach(linea => {

                // Manejo de salto de p√°gina dentro del bucle
                if (yPos + lineHeight > pageHeight - margins.bottom) {
                    pdf.addPage();
                    yPos = margins.top;
                }

                // **Imprimir la l√≠nea con alineaci√≥n 'justify'**
                pdf.text(
                    linea,
                    margins.left, // Empieza en el margen izquierdo
                    yPos,
                    {
                        align: 'justify',
                        maxWidth: textWidth // El ancho m√°ximo para la justificaci√≥n
                    }
                );
                yPos += lineHeight;
            });

            yPos += 20;

            // ---
            // ## Firmas
            // ---
            if (yPos > pageHeight - margins.bottom - 40) {
                pdf.addPage();
                yPos = margins.top;
            }

            const firmaWidth = (textWidth - 20) / 2;
            const firmaX1 = margins.left;
            const firmaX2 = margins.left + firmaWidth + 20;

            contenido.firmas.forEach((firma, index) => {
                const xPos = index === 0 ? firmaX1 : firmaX2;

                pdf.line(xPos, yPos, xPos + firmaWidth, yPos);

                pdf.setFontSize(9);
                pdf.setTextColor(255, 0, 0);
                pdf.setFont(undefined, 'bold');
                pdf.text('Firmado en original', xPos + (firmaWidth / 2), yPos + 5, { align: 'center' });

                pdf.setTextColor(0, 0, 0);
                pdf.setFont(undefined, 'bold');
                pdf.text(firma.nombre, xPos + (firmaWidth / 2), yPos + 10, { align: 'center' });

                pdf.setFont(undefined, 'normal');
                pdf.text(firma.cargo, xPos + (firmaWidth / 2), yPos + 14, { align: 'center' });
            });

            // Guardar PDF
            const numeroContrato = document.getElementById('numeroContrato').value;
            pdf.save(`Acta_Inicio_${numeroContrato}.pdf`);
        }
    </script>
</body>
</html>